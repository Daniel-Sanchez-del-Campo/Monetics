<div class="admin-container">
  <div class="toolbar">
    <div class="toolbar-left">
      <img src="assets/logo-monetics.png" alt="Monetics" class="toolbar-logo">
      <h2 class="toolbar-title">Monetics</h2>
    </div>
    <div class="toolbar-right">
      @if (authService.currentUserValue) {
        <div class="user-info">
          <mat-icon>person</mat-icon>
          <span class="user-name">{{ authService.currentUserValue.nombre }}</span>
          <span class="user-role">Admin</span>
        </div>
        <button mat-icon-button [matMenuTriggerFor]="menu" class="menu-btn">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="volverAlDashboard()">
            <mat-icon>dashboard</mat-icon>
            <span>Dashboard</span>
          </button>
          <button mat-menu-item (click)="logout()">
            <mat-icon>logout</mat-icon>
            <span>Cerrar sesion</span>
          </button>
        </mat-menu>
      }
    </div>
  </div>

  <div class="content">
    <div class="header">
      <h1>
        <mat-icon class="header-icon">admin_panel_settings</mat-icon>
        Gestion de Usuarios
      </h1>
      <button mat-raised-button class="btn-back" (click)="volverAlDashboard()">
        <mat-icon>arrow_back</mat-icon>
        Volver al Dashboard
      </button>
    </div>

    @if (loading) {
      <div class="loading">
        <mat-spinner></mat-spinner>
      </div>
    } @else {
      @if (usuarios.length === 0) {
        <mat-card class="glass-card empty-state">
          <mat-card-content>
            <mat-icon class="empty-icon">group_off</mat-icon>
            <h2>No hay usuarios registrados</h2>
          </mat-card-content>
        </mat-card>
      } @else {
        <mat-card class="glass-card">
          <mat-card-content>
            <table mat-table [dataSource]="usuarios" class="usuarios-table">

              <ng-container matColumnDef="nombre">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon class="th-icon">person</mat-icon> Nombre
                </th>
                <td mat-cell *matCellDef="let usuario">{{ usuario.nombre }}</td>
              </ng-container>

              <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon class="th-icon">email</mat-icon> Email
                </th>
                <td mat-cell *matCellDef="let usuario">{{ usuario.email }}</td>
              </ng-container>

              <ng-container matColumnDef="departamento">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon class="th-icon">business</mat-icon> Departamento
                </th>
                <td mat-cell *matCellDef="let usuario">
                  {{ usuario.departamentoNombre || '-' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="rol">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon class="th-icon">shield</mat-icon> Rol
                </th>
                <td mat-cell *matCellDef="let usuario">
                  <span class="rol-badge" [ngClass]="'rol-' + getRolColor(usuario.rol)">
                    {{ getRolLabel(usuario.rol) }}
                  </span>
                </td>
              </ng-container>

              <ng-container matColumnDef="activo">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon class="th-icon">toggle_on</mat-icon> Activo
                </th>
                <td mat-cell *matCellDef="let usuario">
                  <mat-slide-toggle
                    [checked]="usuario.activo"
                    (change)="toggleActivo(usuario)"
                    color="primary">
                  </mat-slide-toggle>
                </td>
              </ng-container>

              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon class="th-icon">tune</mat-icon> Acciones
                </th>
                <td mat-cell *matCellDef="let usuario">
                  <mat-form-field appearance="outline" class="rol-select">
                    <mat-select
                      [value]="usuario.rol"
                      (selectionChange)="cambiarRol(usuario, $event.value)">
                      <mat-option value="ROLE_USER">Usuario</mat-option>
                      <mat-option value="ROLE_MANAGER">Manager</mat-option>
                      <mat-option value="ROLE_ADMIN">Admin</mat-option>
                    </mat-select>
                  </mat-form-field>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </mat-card-content>
        </mat-card>
      }
    }
  </div>
</div>
